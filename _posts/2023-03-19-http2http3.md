---
title: "HTTP2.0,3.0について調べたこと"
created_at: "2023-03-19"
updated_at: "2023-03-19"
categories: ["network"]
---

## 目次

## ブラウザの速度改善はどうやって行うべきなのか調べていたところ...

仕事で開発しているサービスのフロント側の速度改善ができないか調べていたところ、通信プロトコルのHTTP2.0ってのがそういえばあったけどちゃんと理解してなかったなと思って深堀りしてみることにした。
HTTP3.0もあったので同じく。寄り道である。

## HTTP2.0 vs HTTP1.1
<a href='https://freecontent.manning.com/animation-http-1-1-vs-http-2-vs-http-2-with-push/' target="_blank">HTTP2.0 vs HTTP1.1</a>という記事が図解されていて分かりやすかった。

大きな違いはデータのやり取りの方法。
htmlファイルが、jsファイル、cssファイル, assetsファイルを読み込む。
HTTP1.1ではjs,css,assetsをサーバー側にリクエストする際、一つのリクエストが終えてから次のリクエストというように、分割して作業が行われる。
それに対し、HTTP2.0ではそれぞれのリクエストをひとまとめにして一括でやり取りを行う。
これにより、描画速度の改善が見込める。
HTTP2.0は2015年から正式仕様として承認されている(wikiより)

ただ、デメリットもあるらしい。

ファイルサイズが大きすぎると、逆に速度低下が起きてしまう可能性があるとのこと。
> 【ヘッドオブライン（HoL）ブロッキング問題】<br>10個の画像があり、3つめの画像が大容量だったりレスポンスが返却されるまでに時間がかかると、4つめの画像ダウンロードに進まないといった現象のこと。

HTTP1.1よりは改善されているが、HTTP2.0もTCP接続を行う関係上、途中でパケットが破棄された場合、再度ネゴシエーション(コンピュータで通信を行う際、デバイス同士が通信前にあらかじめ通信プロトコルなどの情報を交換し合うこと)をして回復を図ります。この回復している最中の時間はHTTP2.0であっても手出しができない領域。
<a href='https://blog.redbox.ne.jp/http3-quic.html' target="_blank">HTTP/3 の特徴 HTTP/2とQUICの違い</a>

HTTP/2では遅延や再送がない通信環境においてHTTP1.1で課題となっていたリクエストの並列化はできても、TCPで再送処理が発生してしまうと結局の所引きずられHoLブロッキングと同じ現象がおこってしまう問題が残っていた。

## HTTP3.0
HTTP3.0は2018年に登場。
上記HTTP2.0の課題であったTCP接続がゆえのネゴシエーションの発生による速度低下をHTTP3.0ではUDP(User Datagram Protocol)という通信規格を用いることで解決した。

QUICというgoogleが開発した仕組みを導入した通信プロトコルが鍵。

> 【QUIC】<br>トランスポート層で利用される通信規格をTCPではなく、UDPを使用することで高速な通信を実現

深ぼる前に、QUIC内で使用されているUDPと、HTTP2.0で課題となったTCPについて。

## TCPとUDPの違い

まず、HTTPとTCP,UDPは提供されるレイヤーが異なる。

HTTPはアプリケーション層、TCPならびにUDPはトランスポート層での通信規格。

HTTP2.0で利用されているTCPはコネクション型で3-Way ハンドシェイクと呼ばれる方法で通信を行う。
データを受け取る相手がいることを確認した上で、1つずつ順にデータの送信を行なうことがTCPの特徴と言えます。確実に相手へデータの送信が行えるため、セキュリティー面で信頼度が高いデータのやりとりができる点がメリットですが、接続のためのネゴシエーションにより通信速度は遅くなる。


HTTP3.0で利用されるUDPはコネクションレス型で、パケットの到達保証がないのが特徴。
通信相手の状況を確認せずにデータを送信することができるため、より高速にデータの送信が可能だが、セキュリティー面ではTCPより劣る。そのため、動画や音楽のストリーミングなどに有効とされている。


## HTTP3.0高速化の理由と注意点

高速化の理由

- 接続確立時のハンドシェイク数の減少
> 【ハンドシェイク】<br>通信の接続を確立するためにサーバーとWebブラウザの間で行われる一連の処理

TCPでは、3-Way ハンドシェイクと言われるように通信を確立するために1往復半ハンドシェイクを行う必要があった。QUICの技術では1-RTT ハンドシェイク、すなわち1往復のみで通信を確立できる。
- ヘッドオブラインブロッキングの解消

上記はTCPの課題であった。UDPを使う際は、パケットロスが発生し、パケットを再送する場合でも最短で0-RTTハンドシェイクでパケットが受け取れたり、ロスパケットを受け取らずにデータを処理することもできるため高速化に繋がる。
- 優先度制御の再設計

> 【優先度制御】<br>パケットに優先度をつけて送信すること

HTTP2.0では優先度制御にムラがあったが、QUICの機能によって優先度制御を明確にし、ムラをなくなった。たとえば、ファーストビューの画像は先に表示して、他の画像は追って順番に表示することでユーザーの動きに合わせてスムーズにデータを表示していくことが可能になった。

導入時の注意点
- UDP 443 番ポートの確認

UDP443番ポートが閉じているとHTTP/3を導入できない
- コンテンツの常時SSL化

QUICではTLS1.3が利用されていることから、暗号化通信（SSL証明書の利用）を前提としている。
よってコンテンツの常時SSL化が必要。

## これらを学んで
フロント側の速度改善として、これまではフロント側をなんとかするという方法しか知らなかったが、今回のように通信プロトコルのバージョンアップで対応できる可能性もあるということが知れたのはかなり勉強になった。
バージョンアップによる後方互換性も担保されているみたいだし、特段理由がなければhttp3.0にしても問題ないのではないか？と今の段階では思っている。


## 参考文献
<a href='https://freecontent.manning.com/animation-http-1-1-vs-http-2-vs-http-2-with-push/' target="_blank">HTTP2.0 vs HTTP1.1</a>

<a href='https://www.techfirm.co.jp/blog/http3#1' target="_blank">HTTP/3とは？Webサイトの表示を高速化する理由と注意点を解説</a>

<a href='https://blog.redbox.ne.jp/http3-quic.html' target="_blank">HTTP/3 の特徴 HTTP/2とQUICの違い</a>